<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAVAK ‚Äî Comprar Autos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            color: #000;
            letter-spacing: -1px;
        }

        .nav-links {
            display: flex;
            gap: 35px;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .nav-links a:hover { color: #00d4aa; transform: translateY(-2px); }

        .btn-login {
            background: linear-gradient(135deg, #00d4aa 0%, #00a88f 100%);
            color: white;
            padding: 12px 28px;
            border-radius: 12px;
            border: none;
            text-decoration: none;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
            transition: all 0.3s;
        }

        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4); }

        /* Vehicle Grid */
        .content {
            flex: 1;
            padding: 40px 60px;
            background: #f5f5f5;
        }

        @media (max-width: 900px) {
            .content { padding: 30px 20px; }
        }

        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
        }

        .vehicle-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: 0.2s;
            border: 1px solid #ddd;
        }

        .vehicle-card:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .vehicle-image {
            background: #f4f6f2;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            color: #0b533b;
        }
        .vehicle-image svg { width: 68px; height: 44px; display:block; }

        .vehicle-info {
            padding: 20px;
        }

        .vehicle-title {
            font-weight: 700;
            font-size: 18px;
            color: #1C3D5A;
        }

        .vehicle-details {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }

        .vehicle-price {
            font-size: 18px;
            font-weight: bold;
            color: #1B4332;
            margin-top: 5px;
        }

        .btn-view {
            margin-top: 10px;
            background: #1B4332;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
        }

        .btn-view:hover {
            background: #2D6A4F;
        }

        /* Admin Panel (copied from index.html) */
        .admin-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(6, 42, 79, 0.18);
            z-index: 1000;
            transition: all 0.3s;
        }

        .admin-toggle:hover {
            transform: scale(1.1) rotate(180deg);
        }

        .admin-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 450px;
            max-height: 600px;
            background: #0f1720;
            color: #d4d4d4;
            border-radius: 16px;
            box-shadow: 0 15px 60px rgba(0,0,0,0.6);
            display: none;
            flex-direction: column;
            z-index: 999;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow: hidden;
        }

        .admin-panel.active {
            display: flex;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .admin-header {
            background: linear-gradient(135deg, #062a4f 0%, #0b533b 100%);
            padding: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .admin-header h3 {
            color: white;
            font-size: 16px;
            font-weight: 700;
        }

        .admin-logs {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            background: #252526;
            border-radius: 6px;
            border-left: 3px solid #00d4aa;
            transition: all 0.3s;
        }

        .log-entry:hover {
            background: #2d2d30;
        }

        .log-entry.error {
            border-left-color: #f48771;
            background: rgba(244, 135, 113, 0.1);
        }

        .log-entry.warning {
            border-left-color: #dcdcaa;
            background: rgba(220, 220, 170, 0.1);
        }

        .log-timestamp {
            color: #858585;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .admin-footer {
            padding: 15px;
            background: #2d2d30;
            border-top: 1px solid #3d3d3d;
            display: flex;
            gap: 10px;
        }

        .admin-footer button {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #062a4f 0%, #0b533b 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-footer button:hover {
            transform: translateY(-2px);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            background: #0f1720;
        }

        .stat-mini {
            text-align: center;
            padding: 10px;
            background: #2d2d30;
            border-radius: 8px;
        }

        .stat-mini-value {
            font-size: 20px;
            font-weight: 900;
            color: #1f8a5f;
        }

        .stat-mini-label {
            font-size: 9px;
            color: #858585;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Footer */
        footer {
            background: #1B4332;
            color: white;
            text-align: center;
            padding: 25px;
            font-size: 14px;
            margin-top: auto;
        }

        footer h2 {
            font-weight: 900;
            margin-bottom: 8px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <a class="logo" href="index.html" onclick="if(typeof logAction==='function') logAction('navigation','click_logo');">KAVAK</a>
            <div class="nav-links">
                <a href="comprar.html">Comprar</a>
                <a href="vender.html" onclick="logAction('navigation','click_vender')">Vender</a>
                <a href="ayuda.html" onclick="logAction('navigation','click_ayuda')">Ayuda</a>
                <a href="logs.html" onclick="if(typeof logAction==='function') logAction('navigation','click_logs')">Logs</a>
                <a class="btn-login" href="login.html">Ingresar</a>
            </div>
        </div>
    </div>

    <div class="content" id="content">
        <div class="vehicle-grid" id="vehicleGrid"></div>
    </div>

    <!-- Floating admin toggle removed; use the Logs page from the header nav -->

    <!-- Admin Panel (copied from index.html) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h3>üîç System Logs Monitor (Comprar)</h3>
        </div>
        <div class="admin-stats">
            <div class="stat-mini">
                <div class="stat-mini-value" id="totalEvents">0</div>
                <div class="stat-mini-label">Events</div>
            </div>
            <div class="stat-mini">
                <div class="stat-mini-value" id="errorEvents">0</div>
                <div class="stat-mini-label">Errors</div>
            </div>
            <div class="stat-mini">
                <div class="stat-mini-value" id="userActions">0</div>
                <div class="stat-mini-label">Actions</div>
            </div>
        </div>
        <div class="admin-logs" id="adminLogs"></div>
        <div class="admin-footer">
            <button onclick="downloadLogs()">Download</button>
            <button onclick="clearLogs()">Clear</button>
            <button onclick="syncLogs()">Sync All Pages</button>
        </div>
    </div>

    <footer>
        <h2>KAVAK</h2>
        <p>Compra, vende y financia autos seminuevos con confianza.</p>
        <div style="opacity:0.8; margin-top:8px;">¬© 2025 KAVAK M√©xico ‚Äî Todos los derechos reservados</div>
    </footer>

    <script>
        // ===== LOGGING SYSTEM (Database-Ready Architecture) =====
        const LOG_STORAGE_KEY = 'kavak_logs_comprar';
        const SYNC_CHANNEL = 'kavak_log_sync';
        
        let systemLogs = [];
        let logStats = { total: 0, errors: 0, actions: 0 };
        let sessionId = `COMPRAR_${Date.now()}`;
        let userId = `USR${String(Math.floor(Math.random() * 9000) + 1000).padStart(6, '0')}`;

        const vehicles = [
            { brand: "Toyota", model: "Corolla", year: 2021, price: 310000, mileage: 23000 },
            { brand: "Honda", model: "Civic", year: 2020, price: 295000, mileage: 18000 },
            { brand: "Mazda", model: "3 Sedan", year: 2022, price: 345000, mileage: 12000 },
            { brand: "Nissan", model: "Sentra", year: 2019, price: 260000, mileage: 40000 },
            { brand: "Volkswagen", model: "Jetta", year: 2021, price: 320000, mileage: 15000 },
        ];

        // ===== LOGGING FUNCTIONS =====
        function writeLog(service, level, message, metadata = {}) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                level: level.toUpperCase(),
                service,
                userId,
                sessionId,
                page: 'comprar',
                message,
                metadata,
                raw: `[${timestamp}] ${level.toUpperCase().padEnd(7)} [${service}] [user:${userId}] ${message}`
            };

            systemLogs.push(logEntry);
            logStats.total++;
            if (level === 'error') logStats.errors++;

            persistLogs();
            broadcastLogUpdate(logEntry);
            renderLogEntry(logEntry);
            updateStats();
        }

        function renderLogEntry(logEntry) {
            const logsContainer = document.getElementById('adminLogs');
            if (!logsContainer) return;
            
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${logEntry.level.toLowerCase()}`;
            logDiv.innerHTML = `
                <div class="log-timestamp">${logEntry.timestamp}</div>
                <div><strong>${logEntry.level}</strong> [${logEntry.service}] ${logEntry.message}</div>
            `;
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function logAction(category, action, details = '') {
            logStats.actions++;
            let message = '';
            let service = 'comprar-page';

            switch(category) {
                case 'navigation':
                    service = 'frontend-app';
                    message = `User navigation: ${action} ${details}`.trim();
                    break;
                case 'vehicle':
                    service = 'inventory-service';
                    message = `Vehicle ${action}: ${details}`;
                    break;
                case 'filter':
                    service = 'inventory-service';
                    message = `Filter applied: ${action}=${details}`;
                    break;
                default:
                    message = `${category}: ${action} ${details}`.trim();
                    break;
            }

            writeLog(service, 'info', message);
        }

        // ===== PERSISTENCE (Ready for Database Migration) =====
        function persistLogs() {
            // Current: localStorage
            // Future: Replace with API call -> await fetch('/api/logs', { method: 'POST', body: JSON.stringify(logEntry) })
            try {
                localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(systemLogs));
            } catch (err) {
                console.error('Failed to persist logs', err);
            }
        }

        function loadPersistedLogs() {
            try {
                const stored = localStorage.getItem(LOG_STORAGE_KEY);
                if (stored) {
                    systemLogs = JSON.parse(stored);
                    systemLogs.forEach(log => {
                        renderLogEntry(log);
                        if (log.level === 'ERROR') logStats.errors++;
                        if (log.metadata?.isUserAction) logStats.actions++;
                    });
                    logStats.total = systemLogs.length;
                    updateStats();
                }
            } catch (err) {
                console.error('Failed to load persisted logs', err);
            }
        }

        // Aggregate logs from all pages (keys starting with kavak_logs_)
        function mergeAndRenderLogs(allLogs) {
            const seen = new Set();
            const merged = [];
            allLogs.sort((a,b)=> (a.timestamp||'').localeCompare(b.timestamp||''));
            allLogs.forEach(l => {
                const key = l.raw || `${l.timestamp}|${l.service}|${l.message}`;
                if (!seen.has(key)) { seen.add(key); merged.push(l); }
            });

            const logsContainer = document.getElementById('adminLogs');
            logsContainer.innerHTML = '';
            merged.forEach(l => {
                const div = document.createElement('div');
                const level = (l.level||'INFO').toLowerCase();
                div.className = `log-entry ${level}`;
                div.innerHTML = `\n                    <div class="log-timestamp">${l.timestamp || ''}</div>\n                    <div><strong>${(l.level||'').toUpperCase()}</strong> [${l.service || ''}] ${l.message || ''}</div>\n                `;
                logsContainer.appendChild(div);
            });
            logsContainer.scrollTop = logsContainer.scrollHeight;
            logStats.total = merged.length;
            logStats.errors = merged.filter(x => (x.level||'').toLowerCase() === 'error').length;
            updateStats();
        }

        function loadAllLogsAndRender() {
            try {
                const all = [];
                for (let i=0;i<localStorage.length;i++) {
                    const k = localStorage.key(i);
                    if (!k) continue;
                    if (k.startsWith('kavak_logs_')) {
                        try {
                            const arr = JSON.parse(localStorage.getItem(k) || '[]');
                            if (Array.isArray(arr)) arr.forEach(l => all.push(l));
                        } catch(e) {}
                    }
                }
                // include in-memory logs too
                systemLogs.forEach(s => all.push(s));
                mergeAndRenderLogs(all);
            } catch (err) { console.warn('Failed to load all logs', err); }
        }

        // ===== CROSS-PAGE SYNC =====
        function broadcastLogUpdate(logEntry) {
            try {
                const payload = {
                    type: 'log_update',
                    log: logEntry,
                    timestamp: Date.now()
                };
                localStorage.setItem(SYNC_CHANNEL, JSON.stringify(payload));
                setTimeout(() => {
                    try { localStorage.removeItem(SYNC_CHANNEL); } catch(e) {}
                }, 100);
            } catch (err) {
                console.warn('Failed to broadcast log', err);
            }
        }

        function syncLogs() {
            writeLog('sync-service', 'info', 'Manual sync requested');
            loadPersistedLogs();
        }

        // Listen for logs from other pages
        window.addEventListener('storage', (e) => {
            if (e.key === SYNC_CHANNEL && e.newValue) {
                try {
                    const payload = JSON.parse(e.newValue);
                    if (payload.type === 'log_update' && payload.log) {
                        systemLogs.push(payload.log);
                        renderLogEntry(payload.log);
                        logStats.total++;
                        if (payload.log.level === 'ERROR') logStats.errors++;
                        updateStats();
                    }
                } catch (err) {
                    console.warn('Failed to process sync event', err);
                }
            }
        });

        // ===== ADMIN PANEL CONTROLS =====
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            const opening = !panel.classList.contains('active');
            panel.classList.toggle('active');
            logAction('admin', 'toggle_panel');
            if (opening) loadAllLogsAndRender();
        }

        function updateStats() {
            const totalEl = document.getElementById('totalEvents');
            const errorEl = document.getElementById('errorEvents');
            const actionsEl = document.getElementById('userActions');
            
            if (totalEl) totalEl.textContent = logStats.total;
            if (errorEl) errorEl.textContent = logStats.errors;
            if (actionsEl) actionsEl.textContent = logStats.actions;
        }

        function downloadLogs() {
            try {
                const content = JSON.stringify(systemLogs, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kavak_comprar_logs_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                logAction('admin', 'download_logs');
            } catch (err) {
                console.error('Failed to download logs', err);
            }
        }

        function clearLogs() {
            systemLogs = [];
            document.getElementById('adminLogs').innerHTML = '';
            logStats = { total: 0, errors: 0, actions: 0 };
            updateStats();
            localStorage.removeItem(LOG_STORAGE_KEY);
            logAction('admin', 'clear_logs');
        }

        // ===== VEHICLE RENDERING =====
        function renderVehicles() {
            const grid = document.getElementById('vehicleGrid');
            grid.innerHTML = '';

            vehicles.forEach(v => {
                const card = document.createElement('div');
                card.className = 'vehicle-card';
                card.innerHTML = `
                    <div class="vehicle-image" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 12l1.5-4.5A2 2 0 0 1 6.4 6h11.2a2 2 0 0 1 1.9 1.5L21 12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 16v1.5A1.5 1.5 0 0 0 6.5 19H7a1 1 0 0 0 1-1v-1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 16v1.5A1.5 1.5 0 0 1 17.5 19H17a1 1 0 0 1-1-1v-1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-title">${v.brand} ${v.model}</div>
                        <div class="vehicle-details">
                            <span>üóìÔ∏è ${v.year}</span>
                            <span>üìç ${v.mileage.toLocaleString()} km</span>
                        </div>
                        <div class="vehicle-price">$${v.price.toLocaleString()}</div>
                        <button class="btn-view" onclick="logAction('vehicle','view','${v.brand} ${v.model}')">Ver detalles</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            writeLog('inventory-service', 'info', `Rendered ${vehicles.length} vehicles`);
        }

        // ===== INITIALIZATION =====
        window.onload = () => {
            loadPersistedLogs();
            renderVehicles();
            writeLog('frontend-app', 'info', 'Comprar page initialized successfully');
        };
    </script>
    <!-- BUG INJECTION: comprar page -->
    <script>
        // <<BUG_INJECTION_COMPRAR>>
        (function injectComprarBugs(){
            try {
                const FLAG = 'kavak_injected_bugs_comprar';
                if (localStorage.getItem(FLAG)) return;
                const KEY = 'kavak_logs_comprar';
                const now = new Date().toISOString();
                const samples = [
                    {
                        timestamp: now,
                        level: 'ERROR',
                        service: 'pricing-engine',
                        message: 'Failed to fetch market data for pricing: API timeout after 30s',
                        raw: `[${now}] ERROR   [pricing-engine] Failed to fetch market data for pricing: API timeout after 30s`,
                        userId: 'USR000200', sessionId: 'COMPRAR_SAMPLE', page: 'comprar', metadata: {}
                    },
                    {
                        timestamp: now,
                        level: 'WARNING',
                        service: 'inventory-service',
                        message: 'Vehicle listing missing images for VEH010203',
                        raw: `[${now}] WARNING [inventory-service] Vehicle listing missing images for VEH010203`,
                        userId: 'USR000200', sessionId: 'COMPRAR_SAMPLE', page: 'comprar', metadata: {}
                    },
                    {
                        timestamp: now,
                        level: 'INFO',
                        service: 'user-service',
                        message: 'User USR000200 started a search for Toyota',
                        raw: `[${now}] INFO    [user-service] User USR000200 started a search for Toyota`,
                        userId: 'USR000200', sessionId: 'COMPRAR_SAMPLE', page: 'comprar', metadata: {}
                    }
                ];
                const existing = JSON.parse(localStorage.getItem(KEY) || '[]');
                const merged = samples.concat(existing);
                localStorage.setItem(KEY, JSON.stringify(merged));
                localStorage.setItem(FLAG, '1');
                try { localStorage.setItem('kavak_bug_injected_signal', JSON.stringify({page:'comprar',ts:Date.now()})); localStorage.removeItem('kavak_bug_injected_signal'); } catch(e){}
            } catch (e) { console.error('injectComprarBugs', e); }
        })();
    </script>
</body>
</html>